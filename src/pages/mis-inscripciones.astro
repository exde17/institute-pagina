---
import Layout from '../layouts/Layout.astro';
---

<Layout title="Mis Inscripciones — FCM INSTITUTE">
  <section class="mx-auto max-w-7xl px-4 py-12">
    <!-- Header -->
    <header class="mb-12 text-center animate-fade-in">
      <div class="flex items-center justify-center gap-3 mb-4">
        <div class="w-12 h-12 bg-gradient-to-br from-red-500 to-pink-500 rounded-full flex items-center justify-center">
          <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"/>
          </svg>
        </div>
        <h1 class="text-4xl md:text-5xl font-bold bg-gradient-to-r from-blue-800 via-purple-700 to-blue-600 bg-clip-text text-transparent">
          Panel de Administración
        </h1>
      </div>
      <div class="w-24 h-1 bg-gradient-to-r from-blue-600 to-purple-600 mx-auto rounded-full mb-6"></div>
      <p class="text-lg text-slate-600 max-w-3xl mx-auto">
        Gestiona todas las inscripciones y genera links de pago para los estudiantes.
      </p>
      <div class="mt-4 inline-flex items-center gap-2 px-4 py-2 bg-amber-100 text-amber-800 rounded-full text-sm font-semibold">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
        </svg>
        Solo accesible para administradores
      </div>
    </header>

    <!-- Loading State -->
    <div id="loading-state" class="text-center py-12">
      <div class="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600"></div>
      <p class="mt-4 text-slate-600">Cargando inscripciones...</p>
    </div>

    <!-- Empty State -->
    <div id="empty-state" class="hidden text-center py-12">
      <div class="w-24 h-24 bg-slate-100 rounded-full flex items-center justify-center mx-auto mb-6">
        <svg class="w-12 h-12 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
        </svg>
      </div>
      <h2 class="text-2xl font-bold text-slate-900 mb-2">No hay inscripciones</h2>
      <p class="text-slate-600 mb-6">Aún no hay estudiantes inscritos en los programas.</p>
    </div>

    <!-- Inscripciones List -->
    <div id="inscripciones-list" class="hidden space-y-6">
      <!-- Las inscripciones se renderizarán aquí -->
    </div>

    <!-- Modal de Éxito -->
    <div id="success-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
      <div class="bg-white rounded-2xl p-8 max-w-md w-full transform scale-95 opacity-0 transition-all duration-300" id="success-modal-content">
        <div class="text-center">
          <div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
            <svg class="w-8 h-8 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
            </svg>
          </div>
          <h3 class="text-xl font-bold text-slate-900 mb-2" id="success-title">¡Éxito!</h3>
          <p class="text-slate-600 mb-6" id="success-message">Operación exitosa</p>
          <button id="success-close" class="w-full bg-gradient-to-r from-green-500 to-emerald-500 hover:from-green-600 hover:to-emerald-600 text-white px-6 py-3 rounded-xl font-bold transform hover:scale-105 transition-all duration-300">
            ¡Perfecto!
          </button>
        </div>
      </div>
    </div>

    <!-- Modal de Error -->
    <div id="error-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
      <div class="bg-white rounded-2xl p-8 max-w-md w-full transform scale-95 opacity-0 transition-all duration-300" id="error-modal-content">
        <div class="text-center">
          <div class="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4">
            <svg class="w-8 h-8 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
            </svg>
          </div>
          <h3 class="text-xl font-bold text-slate-900 mb-2" id="error-title">Error</h3>
          <p class="text-slate-600 mb-6" id="error-message">Ha ocurrido un error</p>
          <button id="error-close" class="w-full bg-gradient-to-r from-red-500 to-pink-500 hover:from-red-600 hover:to-pink-600 text-white px-6 py-3 rounded-xl font-bold transform hover:scale-105 transition-all duration-300">
            Entendido
          </button>
        </div>
      </div>
    </div>
  </section>

  <style>
    @keyframes fade-in {
      from {
        opacity: 0;
        transform: translateY(-10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .animate-fade-in {
      animation: fade-in 0.6s ease-out;
    }

    .inscripcion-card {
      animation: fade-in 0.6s ease-out backwards;
    }
  </style>

  <script>
    import { getInscripciones, generarLinkPago, type Inscripcion, getUser } from '../lib/auth.ts';

    // Verificar que el usuario sea admin al cargar la página
    function checkAdminAccess() {
      const user = getUser();
      
      if (!user) {
        // No hay usuario logueado, redirigir al login
        window.location.href = '/auth/login';
        return false;
      }
      
      // Verificar que el usuario tenga rol admin
      const isAdmin = user.role && user.role.includes('admin');
      
      if (!isAdmin) {
        // Usuario no es admin, mostrar error y redirigir
        alert('Acceso denegado. Esta sección es solo para administradores.');
        window.location.href = '/';
        return false;
      }
      
      return true;
    }

    // Función para mostrar modal de éxito
    function showSuccessModal(title: string, message: string) {
      const modal = document.getElementById('success-modal');
      const modalContent = document.getElementById('success-modal-content');
      const titleEl = document.getElementById('success-title');
      const messageEl = document.getElementById('success-message');
      const closeBtn = document.getElementById('success-close');

      if (titleEl) titleEl.textContent = title;
      if (messageEl) messageEl.textContent = message;

      modal?.classList.remove('hidden');
      setTimeout(() => {
        modalContent?.classList.remove('scale-95', 'opacity-0');
        modalContent?.classList.add('scale-100', 'opacity-100');
      }, 10);

      const closeModal = () => {
        modalContent?.classList.remove('scale-100', 'opacity-100');
        modalContent?.classList.add('scale-95', 'opacity-0');
        setTimeout(() => {
          modal?.classList.add('hidden');
        }, 300);
      };

      closeBtn?.addEventListener('click', closeModal, { once: true });
      modal?.addEventListener('click', (e) => {
        if (e.target === modal) closeModal();
      });
    }

    // Función para mostrar modal de error
    function showErrorModal(title: string, message: string) {
      const modal = document.getElementById('error-modal');
      const modalContent = document.getElementById('error-modal-content');
      const titleEl = document.getElementById('error-title');
      const messageEl = document.getElementById('error-message');
      const closeBtn = document.getElementById('error-close');

      if (titleEl) titleEl.textContent = title;
      if (messageEl) messageEl.textContent = message;

      modal?.classList.remove('hidden');
      setTimeout(() => {
        modalContent?.classList.remove('scale-95', 'opacity-0');
        modalContent?.classList.add('scale-100', 'opacity-100');
      }, 10);

      const closeModal = () => {
        modalContent?.classList.remove('scale-100', 'opacity-100');
        modalContent?.classList.add('scale-95', 'opacity-0');
        setTimeout(() => {
          modal?.classList.add('hidden');
        }, 300);
      };

      closeBtn?.addEventListener('click', closeModal, { once: true });
      modal?.addEventListener('click', (e) => {
        if (e.target === modal) closeModal();
      });
    }

    // Función para formatear números como moneda
    function formatCurrency(amount: string | number): string {
      const num = typeof amount === 'string' ? parseFloat(amount) : amount;
      return new Intl.NumberFormat('es-CO', {
        style: 'currency',
        currency: 'COP',
        minimumFractionDigits: 0,
        maximumFractionDigits: 0,
      }).format(num);
    }

    // Función para formatear fecha
    function formatDate(dateString: string): string {
      const date = new Date(dateString);
      return new Intl.DateTimeFormat('es-CO', {
        year: 'numeric',
        month: 'long',
        day: 'numeric',
      }).format(date);
    }

    // Función para obtener clase de color del badge de estado
    function getEstadoBadgeClass(estado: string): string {
      switch (estado) {
        case 'Completado':
          return 'bg-green-100 text-green-800';
        case 'Pendiente':
          return 'bg-yellow-100 text-yellow-800';
        case 'Fallido':
          return 'bg-red-100 text-red-800';
        default:
          return 'bg-gray-100 text-gray-800';
      }
    }

    // Función para renderizar inscripciones
    function renderInscripciones(inscripciones: Inscripcion[]) {
      const list = document.getElementById('inscripciones-list');
      if (!list) return;

      list.innerHTML = '';

      inscripciones.forEach((inscripcion, index) => {
        const card = document.createElement('div');
        card.className = 'inscripcion-card bg-white rounded-2xl overflow-hidden shadow-lg hover:shadow-2xl transition-all duration-300';
        card.style.animationDelay = `${index * 0.1}s`;

        const pagoActual = inscripcion.pagos[0]; // Asumimos que hay al menos un pago
        const estadoPago = pagoActual?.estado || 'Pendiente';
        const montoPago = pagoActual?.monto || inscripcion.programa.costo;

        card.innerHTML = `
          <div class="md:flex">
            <!-- Imagen del programa -->
            <div class="md:w-1/3 relative h-64 md:h-auto overflow-hidden">
              <img 
                src="${inscripcion.programa.imagen}" 
                alt="${inscripcion.programa.nombre}"
                class="w-full h-full object-cover"
              />
              <div class="absolute inset-0 bg-gradient-to-t from-slate-900 via-slate-900/50 to-transparent opacity-70"></div>
              <div class="absolute top-4 left-4">
                <span class="px-3 py-1 rounded-full text-xs font-bold text-white ${
                  inscripcion.programa.badgeColor === 'green' ? 'bg-green-500' :
                  inscripcion.programa.badgeColor === 'purple' ? 'bg-purple-500' :
                  inscripcion.programa.badgeColor === 'blue' ? 'bg-blue-500' :
                  inscripcion.programa.badgeColor === 'pink' ? 'bg-pink-500' :
                  'bg-orange-500'
                }">
                  ${inscripcion.programa.badge}
                </span>
              </div>
            </div>

            <!-- Contenido -->
            <div class="md:w-2/3 p-6">
              <div class="flex justify-between items-start mb-4">
                <div>
                  <h2 class="text-2xl font-bold text-slate-900 mb-2">${inscripcion.programa.nombre}</h2>
                  <p class="text-sm text-slate-600">${inscripcion.programa.categoria}</p>
                </div>
                <span class="px-3 py-1 rounded-full text-xs font-bold ${getEstadoBadgeClass(estadoPago)}">
                  ${estadoPago}
                </span>
              </div>

              <p class="text-slate-600 text-sm mb-4">${inscripcion.programa.descripcion}</p>

              <!-- Información de la inscripción -->
              <div class="grid md:grid-cols-2 gap-4 mb-6">
                <div class="bg-slate-50 rounded-lg p-4">
                  <div class="flex items-center gap-2 mb-2">
                    <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                    </svg>
                    <span class="text-xs font-bold text-slate-700">Fecha de Inscripción</span>
                  </div>
                  <p class="text-sm text-slate-900">${formatDate(inscripcion.fechaInscripcion)}</p>
                </div>

                <div class="bg-slate-50 rounded-lg p-4">
                  <div class="flex items-center gap-2 mb-2">
                    <svg class="w-5 h-5 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>
                    <span class="text-xs font-bold text-slate-700">Duración</span>
                  </div>
                  <p class="text-sm text-slate-900">${inscripcion.programa.duracion} semestres</p>
                </div>

                <div class="bg-slate-50 rounded-lg p-4">
                  <div class="flex items-center gap-2 mb-2">
                    <svg class="w-5 h-5 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z"/>
                    </svg>
                    <span class="text-xs font-bold text-slate-700">Costo Total</span>
                  </div>
                  <p class="text-lg font-bold text-slate-900">${formatCurrency(montoPago)}</p>
                </div>

                <div class="bg-slate-50 rounded-lg p-4">
                  <div class="flex items-center gap-2 mb-2">
                    <svg class="w-5 h-5 text-orange-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"/>
                    </svg>
                    <span class="text-xs font-bold text-slate-700">Modalidad</span>
                  </div>
                  <p class="text-sm text-slate-900">${inscripcion.programa.modalidad}</p>
                </div>
              </div>

              ${inscripcion.observacion ? `
                <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6">
                  <div class="flex items-start gap-2">
                    <svg class="w-5 h-5 text-blue-600 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>
                    <div>
                      <p class="text-xs font-bold text-blue-900 mb-1">Observación:</p>
                      <p class="text-sm text-blue-800">${inscripcion.observacion}</p>
                    </div>
                  </div>
                </div>
              ` : ''}

              <!-- Botón de pago -->
              ${estadoPago === 'Pendiente' && pagoActual ? `
                <button 
                  class="btn-generar-pago w-full bg-gradient-to-r from-green-600 to-emerald-600 hover:from-green-700 hover:to-emerald-700 text-white rounded-xl px-6 py-4 font-bold transform hover:scale-105 transition-all duration-300 shadow-lg hover:shadow-xl"
                  data-pago-id="${pagoActual.id}"
                  data-programa-nombre="${inscripcion.programa.nombre}"
                  data-monto="${montoPago}"
                >
                  <span class="flex items-center justify-center gap-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z"/>
                    </svg>
                    Generar Link de Pago
                  </span>
                </button>
              ` : estadoPago === 'Completado' ? `
                <div class="bg-green-50 border-2 border-green-200 rounded-xl p-4 text-center">
                  <div class="flex items-center justify-center gap-2 text-green-800">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>
                    <span class="font-bold">Pago Completado</span>
                  </div>
                  ${pagoActual.fechaPago ? `
                    <p class="text-sm text-green-700 mt-2">Fecha: ${formatDate(pagoActual.fechaPago)}</p>
                  ` : ''}
                </div>
              ` : ''}
            </div>
          </div>
        `;

        list.appendChild(card);
      });

      // Agregar event listeners a los botones de pago
      attachPaymentListeners();
    }

    // Función para adjuntar event listeners a los botones de pago
    function attachPaymentListeners() {
      const buttons = document.querySelectorAll('.btn-generar-pago');
      
      buttons.forEach(btn => {
        btn.addEventListener('click', async (e) => {
          const button = e.currentTarget as HTMLButtonElement;
          const pagoId = button.dataset.pagoId;
          const programaNombre = button.dataset.programaNombre;
          const monto = button.dataset.monto;

          if (!pagoId) return;

          // Deshabilitar botón
          button.disabled = true;
          button.innerHTML = `
            <span class="flex items-center justify-center gap-2">
              <svg class="animate-spin h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
              </svg>
              Generando link...
            </span>
          `;

          try {
            const result = await generarLinkPago(pagoId);
            
            // Redirigir a la página de pago de Wompi
            if (result.url) {
              showSuccessModal(
                '¡Link Generado!',
                `Serás redirigido a la página de pago para "${programaNombre}". Monto: ${formatCurrency(monto || '0')}`
              );
              
              // Esperar 2 segundos y redirigir
              setTimeout(() => {
                window.location.href = result.url;
              }, 2000);
            }
          } catch (error) {
            console.error('Error al generar link de pago:', error);
            showErrorModal(
              'Error al Generar Link',
              error instanceof Error ? error.message : 'No se pudo generar el link de pago. Por favor, intenta nuevamente.'
            );
            
            // Restaurar botón
            button.disabled = false;
            button.innerHTML = `
              <span class="flex items-center justify-center gap-2">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z"/>
                </svg>
                Generar Link de Pago
              </span>
            `;
          }
        });
      });
    }

    // Cargar inscripciones al cargar la página
    document.addEventListener('DOMContentLoaded', async () => {
      // Verificar acceso de admin primero
      if (!checkAdminAccess()) {
        return; // Detener ejecución si no es admin
      }

      const loadingState = document.getElementById('loading-state');
      const emptyState = document.getElementById('empty-state');
      const inscripcionesList = document.getElementById('inscripciones-list');

      try {
        const inscripciones = await getInscripciones();
        
        loadingState?.classList.add('hidden');

        if (inscripciones.length === 0) {
          emptyState?.classList.remove('hidden');
        } else {
          inscripcionesList?.classList.remove('hidden');
          renderInscripciones(inscripciones);
        }
      } catch (error) {
        console.error('Error al cargar inscripciones:', error);
        loadingState?.classList.add('hidden');
        showErrorModal(
          'Error al Cargar',
          'No se pudieron cargar las inscripciones. Por favor, intenta nuevamente.'
        );
      }
    });
  </script>
</Layout>
